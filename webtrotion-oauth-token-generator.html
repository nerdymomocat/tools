<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Webtrotion OAuth Token Generator</title>
		<link
			href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Space+Grotesk:wght@400;600;700&display=swap"
			rel="stylesheet"
		/>
		<style>
			:root {
				--bg-light: 246, 247, 249;
				--text-light: 26, 28, 30;
				--accent-light: 180, 95, 55;
				--border-width: 3px;
				--shadow-offset: 4px;
			}

			body {
				background-color: rgb(var(--bg-light));
				color: rgb(var(--text-light));
				font-family: "Space Grotesk", sans-serif;
				margin: 0;
				padding: 24px 14px 60px;
			}

			.mono {
				font-family: "JetBrains Mono", monospace;
			}

			.wrap {
				max-width: 860px;
				margin: 0 auto;
			}

			.nb-box {
				background: white;
				border: var(--border-width) solid black;
				box-shadow: var(--shadow-offset) var(--shadow-offset) 0px black;
				transition: all 0.1s ease-in-out;
			}

			.nb-box:hover {
				transform: translate(-1px, -1px);
				box-shadow: calc(var(--shadow-offset) + 2px) calc(var(--shadow-offset) + 2px) 0px black;
			}

			.nb-input {
				border: var(--border-width) solid black;
				padding: 0.6rem;
				width: 100%;
				font-family: "JetBrains Mono", monospace;
				outline: none;
				background: #fff;
				box-sizing: border-box;
			}

			.nb-input:focus {
				background-color: #f0f0f0;
				box-shadow: 2px 2px 0px black;
			}

			.nb-button {
				background-color: rgb(var(--accent-light));
				color: white;
				border: var(--border-width) solid black;
				padding: 0.6rem 1.3rem;
				font-weight: bold;
				cursor: pointer;
				box-shadow: var(--shadow-offset) var(--shadow-offset) 0px black;
				text-transform: uppercase;
				font-family: "Space Grotesk", sans-serif;
			}

			.nb-button:active {
				transform: translate(var(--shadow-offset), var(--shadow-offset));
				box-shadow: 0 0 0 black;
			}

			.nb-button.secondary {
				background-color: white;
				color: black;
			}

			.nb-label {
				font-weight: 700;
				margin-bottom: 0.25rem;
				display: block;
				font-size: 0.9rem;
				text-transform: uppercase;
			}

			.header {
				padding: 1.1rem;
				margin-bottom: 1rem;
			}

			.card {
				padding: 1.2rem;
				margin-bottom: 1rem;
			}

			.actions {
				display: flex;
				gap: 0.65rem;
				flex-wrap: wrap;
				margin-top: 1rem;
			}

			.hidden {
				display: none;
			}

			.warn {
				background: #fff4f4;
				border: var(--border-width) solid black;
				box-shadow: var(--shadow-offset) var(--shadow-offset) 0px black;
				padding: 0.7rem;
				font-weight: 700;
			}
		</style>
	</head>
	<body>
		<div class="wrap">
			<section class="nb-box header">
				<h1 style="margin: 0 0 0.5rem">Webtrotion OAuth Token Generator</h1>
				<p style="margin: 0 0 0.5rem">
					This gets your public integration token for markdown API usage.
				</p>
			</section>

			<section class="nb-box card">
				<button id="startOauthBtn" class="nb-button">Start Notion OAuth</button>
			</section>

			<section id="resultCard" class="nb-box card hidden">
				<div id="errorBox" class="warn hidden" style="margin-bottom: 1rem"></div>
				<label for="accessToken" class="nb-label">NOTION_OAUTH_TOKEN_FOR_MARKDOWN_API</label>
				<textarea id="accessToken" class="nb-input mono" rows="5" readonly></textarea>
				<div class="actions">
					<button id="copyTokenBtn" class="nb-button">Copy token</button>
					<button id="clearHashBtn" class="nb-button secondary">Clear token from URL</button>
				</div>
			</section>
		</div>

		<script>
			(function () {
				const fixedWorkerUrl =
					"https://webtrotion-notion-oauth-token-generator.nerdymomocat.workers.dev";
				const startOauthBtn = document.getElementById("startOauthBtn");
				const resultCard = document.getElementById("resultCard");
				const errorBox = document.getElementById("errorBox");
				const accessTokenEl = document.getElementById("accessToken");
				const copyTokenBtn = document.getElementById("copyTokenBtn");
				const clearHashBtn = document.getElementById("clearHashBtn");

				function readCallbackParams() {
					const hash = window.location.hash.startsWith("#")
						? window.location.hash.slice(1)
						: window.location.hash;
					const hashParams = new URLSearchParams(hash);
					const queryParams = new URLSearchParams(window.location.search);
					return {
						accessToken: hashParams.get("accessToken") || queryParams.get("accessToken") || "",
						error: hashParams.get("error") || queryParams.get("error") || "",
					};
				}

				function renderResult() {
					const params = readCallbackParams();
					if (!params.accessToken && !params.error) return;
					resultCard.classList.remove("hidden");
					accessTokenEl.value = params.accessToken || "";
					if (params.error) {
						errorBox.classList.remove("hidden");
						errorBox.textContent = "OAuth returned an error: " + params.error;
					}
				}

				startOauthBtn.addEventListener("click", function () {
					const loginUrl = new URL("/auth/login", fixedWorkerUrl);
					window.location.href = loginUrl.toString();
				});

				copyTokenBtn.addEventListener("click", async function () {
					const token = accessTokenEl.value.trim();
					if (!token) {
						alert("No token found.");
						return;
					}
					try {
						await navigator.clipboard.writeText(token);
					} catch {
						accessTokenEl.focus();
						accessTokenEl.select();
						document.execCommand("copy");
					}
					alert("Copied.");
				});

				clearHashBtn.addEventListener("click", function () {
					const cleanUrl = window.location.origin + window.location.pathname;
					window.history.replaceState({}, document.title, cleanUrl);
					resultCard.classList.add("hidden");
					errorBox.classList.add("hidden");
					errorBox.textContent = "";
					accessTokenEl.value = "";
				});

				renderResult();
			})();
		</script>
	</body>
</html>
