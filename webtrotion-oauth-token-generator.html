<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Webtrotion OAuth Token Generator</title>
		<link
			href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Space+Grotesk:wght@400;600;700&display=swap"
			rel="stylesheet"
		/>
		<style>
			:root {
				--bg-light: 246, 247, 249;
				--text-light: 26, 28, 30;
				--accent-light: 180, 95, 55;
				--border-width: 3px;
				--shadow-offset: 4px;
			}

			body {
				background-color: rgb(var(--bg-light));
				color: rgb(var(--text-light));
				font-family: "Space Grotesk", sans-serif;
				margin: 0;
				padding: 24px 14px 60px;
			}

			.mono {
				font-family: "JetBrains Mono", monospace;
			}

			.wrap {
				max-width: 860px;
				margin: 0 auto;
			}

			.nb-box {
				background: white;
				border: var(--border-width) solid black;
				box-shadow: var(--shadow-offset) var(--shadow-offset) 0px black;
				transition: all 0.1s ease-in-out;
			}

			.nb-box:hover {
				transform: translate(-1px, -1px);
				box-shadow: calc(var(--shadow-offset) + 2px) calc(var(--shadow-offset) + 2px) 0px black;
			}

			.nb-input {
				border: var(--border-width) solid black;
				padding: 0.6rem;
				width: 100%;
				font-family: "JetBrains Mono", monospace;
				outline: none;
				background: #fff;
				box-sizing: border-box;
			}

			.nb-input:focus {
				background-color: #f0f0f0;
				box-shadow: 2px 2px 0px black;
			}

			.nb-button {
				background-color: rgb(var(--accent-light));
				color: white;
				border: var(--border-width) solid black;
				padding: 0.6rem 1.3rem;
				font-weight: bold;
				cursor: pointer;
				box-shadow: var(--shadow-offset) var(--shadow-offset) 0px black;
				text-transform: uppercase;
				font-family: "Space Grotesk", sans-serif;
			}

			.nb-button:active {
				transform: translate(var(--shadow-offset), var(--shadow-offset));
				box-shadow: 0 0 0 black;
			}

			.nb-button.secondary {
				background-color: white;
				color: black;
			}

			.nb-button.copied {
				background-color: #1f6f43;
				color: white;
			}

			.nb-button .copy-icon {
				display: none;
				width: 16px;
				height: 16px;
				vertical-align: -3px;
				margin-right: 6px;
			}

			.nb-button.copied .copy-icon {
				display: inline-block;
			}

			.nb-label {
				font-weight: 700;
				margin-bottom: 0.25rem;
				display: block;
				font-size: 0.9rem;
				text-transform: uppercase;
			}

			.header {
				padding: 1.1rem;
				margin-bottom: 1rem;
			}

			.card {
				padding: 1.2rem;
				margin-bottom: 1rem;
			}

			.actions {
				display: flex;
				gap: 0.65rem;
				flex-wrap: wrap;
				margin-top: 1rem;
			}

			.hidden {
				display: none;
			}

			.warn {
				background: #fff4f4;
				border: var(--border-width) solid black;
				box-shadow: var(--shadow-offset) var(--shadow-offset) 0px black;
				padding: 0.7rem;
				font-weight: 700;
			}
		</style>
	</head>
	<body>
		<div class="wrap">
			<section class="nb-box header">
				<h1 style="margin: 0 0 0.5rem">Webtrotion OAuth Token Generator</h1>
				<p style="margin: 0 0 0.5rem">
					This gets your public integration token for markdown API usage.
				</p>
			</section>

			<section class="nb-box card">
				<button id="startOauthBtn" class="nb-button">Start Notion OAuth</button>
			</section>

			<section id="resultCard" class="nb-box card hidden">
				<div id="errorBox" class="warn hidden" style="margin-bottom: 1rem"></div>
				<label id="tokenLabel" for="accessToken" class="nb-label"
					>NOTION_OAUTH_TOKEN_FOR_MARKDOWN_API</label
				>
				<input id="accessToken" class="nb-input mono" type="password" readonly />
				<div id="tokenActions" class="actions">
					<button id="copyTokenBtn" class="nb-button">
						<svg
							class="copy-icon"
							xmlns="http://www.w3.org/2000/svg"
							width="256"
							height="256"
							viewBox="0 0 256 256"
							aria-hidden="true"
						>
							<path
								fill="currentColor"
								d="M225.86 102.82c-3.77-3.94-7.67-8-9.14-11.57c-1.36-3.27-1.44-8.69-1.52-13.94c-.15-9.76-.31-20.82-8-28.51s-18.75-7.85-28.51-8c-5.25-.08-10.67-.16-13.94-1.52c-3.56-1.47-7.63-5.37-11.57-9.14C146.28 23.51 138.44 16 128 16s-18.27 7.51-25.18 14.14c-3.94 3.77-8 7.67-11.57 9.14c-3.25 1.36-8.69 1.44-13.94 1.52c-9.76.15-20.82.31-28.51 8s-7.8 18.75-8 28.51c-.08 5.25-.16 10.67-1.52 13.94c-1.47 3.56-5.37 7.63-9.14 11.57C23.51 109.72 16 117.56 16 128s7.51 18.27 14.14 25.18c3.77 3.94 7.67 8 9.14 11.57c1.36 3.27 1.44 8.69 1.52 13.94c.15 9.76.31 20.82 8 28.51s18.75 7.85 28.51 8c5.25.08 10.67.16 13.94 1.52c3.56 1.47 7.63 5.37 11.57 9.14c6.9 6.63 14.74 14.14 25.18 14.14s18.27-7.51 25.18-14.14c3.94-3.77 8-7.67 11.57-9.14c3.27-1.36 8.69-1.44 13.94-1.52c9.76-.15 20.82-.31 28.51-8s7.85-18.75 8-28.51c.08-5.25.16-10.67 1.52-13.94c1.47-3.56 5.37-7.63 9.14-11.57c6.63-6.9 14.14-14.74 14.14-25.18s-7.51-18.27-14.14-25.18m-52.2 6.84l-56 56a8 8 0 0 1-11.32 0l-24-24a8 8 0 0 1 11.32-11.32L112 148.69l50.34-50.35a8 8 0 0 1 11.32 11.32"
							/>
						</svg>
						<span id="copyTokenBtnText">Copy token</span>
					</button>
					<button id="toggleTokenVisibilityBtn" class="nb-button secondary">Show token</button>
					<button id="clearHashBtn" class="nb-button secondary">Clear token</button>
				</div>
			</section>
		</div>

		<script>
			(function () {
				const fixedWorkerUrl =
					"https://webtrotion-notion-oauth-token-generator.nerdymomocat.workers.dev";
				const startOauthBtn = document.getElementById("startOauthBtn");
				const resultCard = document.getElementById("resultCard");
				const errorBox = document.getElementById("errorBox");
				const tokenLabel = document.getElementById("tokenLabel");
				const accessTokenEl = document.getElementById("accessToken");
				const tokenActions = document.getElementById("tokenActions");
				const copyTokenBtn = document.getElementById("copyTokenBtn");
				const copyTokenBtnText = document.getElementById("copyTokenBtnText");
				const toggleTokenVisibilityBtn = document.getElementById("toggleTokenVisibilityBtn");
				const clearHashBtn = document.getElementById("clearHashBtn");
				let copyResetTimer = null;

				function setCopyButtonDefault() {
					copyTokenBtnText.textContent = "Copy token";
					copyTokenBtn.classList.remove("copied");
				}

				function setTokenVisibility(visible) {
					tokenLabel.classList.toggle("hidden", !visible);
					accessTokenEl.classList.toggle("hidden", !visible);
					tokenActions.classList.toggle("hidden", !visible);
				}

				function readCallbackParams() {
					const hash = window.location.hash.startsWith("#")
						? window.location.hash.slice(1)
						: window.location.hash;
					const hashParams = new URLSearchParams(hash);
					const queryParams = new URLSearchParams(window.location.search);
					return {
						accessToken: hashParams.get("accessToken") || queryParams.get("accessToken") || "",
						error: hashParams.get("error") || queryParams.get("error") || "",
					};
				}

				function renderResult() {
					const params = readCallbackParams();
					if (!params.accessToken && !params.error) return;
					const cleanUrl = window.location.origin + window.location.pathname;
					window.history.replaceState({}, document.title, cleanUrl);
					resultCard.classList.remove("hidden");
					accessTokenEl.value = params.accessToken || "";
					setTokenVisibility(!!params.accessToken);
					setCopyButtonDefault();
					if (params.error) {
						errorBox.classList.remove("hidden");
						errorBox.textContent = "OAuth returned an error: " + params.error;
					} else {
						errorBox.classList.add("hidden");
						errorBox.textContent = "";
					}
				}

				startOauthBtn.addEventListener("click", function () {
					const loginUrl = new URL("/auth/login", fixedWorkerUrl);
					window.location.href = loginUrl.toString();
				});

				copyTokenBtn.addEventListener("click", async function () {
					const token = accessTokenEl.value.trim();
					if (!token) {
						return;
					}
					try {
						await navigator.clipboard.writeText(token);
					} catch {
						accessTokenEl.focus();
						accessTokenEl.select();
						document.execCommand("copy");
					}
					copyTokenBtnText.textContent = "Copied";
					copyTokenBtn.classList.add("copied");
					if (copyResetTimer) {
						clearTimeout(copyResetTimer);
					}
					copyResetTimer = setTimeout(setCopyButtonDefault, 1600);
				});

				toggleTokenVisibilityBtn.addEventListener("click", function () {
					const isHidden = accessTokenEl.type === "password";
					accessTokenEl.type = isHidden ? "text" : "password";
					toggleTokenVisibilityBtn.textContent = isHidden ? "Hide token" : "Show token";
				});

				clearHashBtn.addEventListener("click", function () {
					accessTokenEl.value = "";
					accessTokenEl.type = "password";
					toggleTokenVisibilityBtn.textContent = "Show token";
					setCopyButtonDefault();
					setTokenVisibility(false);
					resultCard.classList.add("hidden");
					errorBox.classList.add("hidden");
					errorBox.textContent = "";
				});

				renderResult();
			})();
		</script>
	</body>
</html>
